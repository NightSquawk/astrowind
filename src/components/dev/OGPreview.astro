---
/**
 * Open Graph Preview Component
 *
 * A development-only component that shows how your page will look when shared on social media.
 * Displays a preview of your Open Graph meta tags (Facebook, Twitter, LinkedIn, etc.)
 *
 * Usage:
 * Only show in development mode:
 * {import.meta.env.DEV && <OGPreview />}
 */
import { Icon } from 'astro-icon/components';

interface Props {
  /**
   * Position of the preview widget
   * @default 'bottom-right'
   */
  position?: 'bottom-right' | 'bottom-left' | 'top-right' | 'top-left';
}

const { position = 'bottom-right' } = Astro.props;

const positionClasses = {
  'bottom-right': 'bottom-4 right-4',
  'bottom-left': 'bottom-4 left-4',
  'top-right': 'top-4 right-4',
  'top-left': 'top-4 left-4',
};

// Only render in development
if (!import.meta.env.DEV) {
  return null;
}
---

<div id="og-preview-widget" class={`fixed ${positionClasses[position]} z-50`}>
  <!-- Toggle Button -->
  <button
    id="og-preview-toggle"
    class="bg-purple-600 hover:bg-purple-700 text-white rounded-full p-3 shadow-lg transition-colors"
    aria-label="Toggle Open Graph Preview"
    title="Open Graph Preview"
  >
    <Icon name="lucide:share-2" class="w-6 h-6" />
  </button>

  <!-- Preview Panel -->
  <div
    id="og-preview-panel"
    class="hidden absolute bottom-16 right-0 w-96 bg-white dark:bg-gray-800 rounded-lg shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden"
  >
    <!-- Header -->
    <div class="bg-purple-600 text-white px-4 py-3 flex justify-between items-center">
      <h3 class="font-semibold flex items-center gap-2">
        <Icon name="lucide:share-2" class="w-4 h-4" />
         OG Preview
      </h3>
      <button id="og-preview-close" class="hover:bg-purple-700 rounded p-1" aria-label="Close">
        <Icon name="lucide:x" class="w-4 h-4" />
      </button>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-200 dark:border-gray-700">
      <div class="flex">
        <button
          class="og-tab-button flex-1 px-4 py-2 text-sm font-medium border-b-2 transition-colors"
          data-tab="facebook"
        >
          <Icon name="lucide:facebook" class="w-4 h-4 inline mr-1" />
           Facebook
        </button>
        <button
          class="og-tab-button flex-1 px-4 py-2 text-sm font-medium border-b-2 border-transparent transition-colors"
          data-tab="twitter"
        >
          <Icon name="lucide:twitter" class="w-4 h-4 inline mr-1" />
           Twitter
        </button>
        <button
          class="og-tab-button flex-1 px-4 py-2 text-sm font-medium border-b-2 border-transparent transition-colors"
          data-tab="linkedin"
        >
          <Icon name="lucide:linkedin" class="w-4 h-4 inline mr-1" />
           LinkedIn
        </button>
      </div>
    </div>

    <!-- Preview Content -->
    <div class="p-4 max-h-96 overflow-y-auto">
      <!-- Facebook Preview -->
      <div id="og-tab-facebook" class="og-tab-content">
        <div class="border border-gray-200 dark:border-gray-700 rounded overflow-hidden">
          <div id="og-facebook-image" class="bg-gray-100 dark:bg-gray-900 aspect-video flex items-center justify-center">
            <Icon name="lucide:image" class="w-12 h-12 text-gray-400" />
          </div>
          <div class="p-3 bg-gray-50 dark:bg-gray-900">
            <p id="og-facebook-url" class="text-xs text-gray-500 dark:text-gray-400 uppercase mb-1">
              loading...
            </p>
            <h4 id="og-facebook-title" class="font-semibold text-gray-900 dark:text-gray-100 mb-1 line-clamp-2">
              Loading title...
            </h4>
            <p id="og-facebook-description" class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">
              Loading description...
            </p>
          </div>
        </div>
      </div>

      <!-- Twitter Preview -->
      <div id="og-tab-twitter" class="og-tab-content hidden">
        <div class="border border-gray-200 dark:border-gray-700 rounded overflow-hidden">
          <div id="og-twitter-image" class="bg-gray-100 dark:bg-gray-900 aspect-video flex items-center justify-center">
            <Icon name="lucide:image" class="w-12 h-12 text-gray-400" />
          </div>
          <div class="p-3">
            <h4 id="og-twitter-title" class="font-semibold text-gray-900 dark:text-gray-100 mb-1 line-clamp-1">
              Loading title...
            </h4>
            <p id="og-twitter-description" class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-2">
              Loading description...
            </p>
            <p id="og-twitter-url" class="text-xs text-gray-500 dark:text-gray-400">
              loading...
            </p>
          </div>
        </div>
      </div>

      <!-- LinkedIn Preview -->
      <div id="og-tab-linkedin" class="og-tab-content hidden">
        <div class="border border-gray-200 dark:border-gray-700 rounded overflow-hidden">
          <div id="og-linkedin-image" class="bg-gray-100 dark:bg-gray-900 aspect-video flex items-center justify-center">
            <Icon name="lucide:image" class="w-12 h-12 text-gray-400" />
          </div>
          <div class="p-3 bg-gray-50 dark:bg-gray-900">
            <h4 id="og-linkedin-title" class="font-semibold text-gray-900 dark:text-gray-100 mb-1 line-clamp-2">
              Loading title...
            </h4>
            <p id="og-linkedin-url" class="text-xs text-gray-500 dark:text-gray-400">
              loading...
            </p>
          </div>
        </div>
      </div>

      <!-- Meta Tags Info -->
      <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        <button
          id="og-show-meta-tags"
          class="text-sm text-purple-600 dark:text-purple-400 hover:underline flex items-center gap-1"
        >
          <Icon name="lucide:code" class="w-4 h-4" />
           Show Meta Tags
        </button>
        <div id="og-meta-tags" class="hidden mt-2">
          <pre
            class="text-xs bg-gray-100 dark:bg-gray-900 p-3 rounded overflow-x-auto"
            id="og-meta-tags-content"></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .og-tab-button {
    color: rgb(107 114 128);
  }

  .og-tab-button[data-active='true'] {
    color: rgb(147 51 234);
    border-bottom-color: rgb(147 51 234);
  }

  .line-clamp-1 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
  }

  .line-clamp-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
</style>

<script>
  // Only run in development
  if (import.meta.env.DEV) {
    const toggleButton = document.getElementById('og-preview-toggle');
    const panel = document.getElementById('og-preview-panel');
    const closeButton = document.getElementById('og-preview-close');
    const tabButtons = document.querySelectorAll('.og-tab-button');
    const showMetaTagsButton = document.getElementById('og-show-meta-tags');
    const metaTagsDiv = document.getElementById('og-meta-tags');

    // Toggle panel
    toggleButton?.addEventListener('click', () => {
      panel?.classList.toggle('hidden');
      if (!panel?.classList.contains('hidden')) {
        loadOGData();
      }
    });

    closeButton?.addEventListener('click', () => {
      panel?.classList.add('hidden');
    });

    // Tab switching
    tabButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const tab = button.getAttribute('data-tab');

        // Update button states
        tabButtons.forEach((btn) => {
          btn.setAttribute('data-active', 'false');
        });
        button.setAttribute('data-active', 'true');

        // Show/hide tab content
        document.querySelectorAll('.og-tab-content').forEach((content) => {
          content.classList.add('hidden');
        });
        document.getElementById(`og-tab-${tab}`)?.classList.remove('hidden');
      });
    });

    // Initialize first tab as active
    tabButtons[0]?.setAttribute('data-active', 'true');

    // Show/hide meta tags
    showMetaTagsButton?.addEventListener('click', () => {
      metaTagsDiv?.classList.toggle('hidden');
    });

    // Load OG data
    function loadOGData() {
      // Get meta tags
      const ogTitle =
        document.querySelector('meta[property="og:title"]')?.getAttribute('content') ||
        document.querySelector('meta[name="twitter:title"]')?.getAttribute('content') ||
        document.querySelector('title')?.textContent ||
        'No title found';

      const ogDescription =
        document.querySelector('meta[property="og:description"]')?.getAttribute('content') ||
        document.querySelector('meta[name="twitter:description"]')?.getAttribute('content') ||
        document.querySelector('meta[name="description"]')?.getAttribute('content') ||
        'No description found';

      const ogImage =
        document.querySelector('meta[property="og:image"]')?.getAttribute('content') ||
        document.querySelector('meta[name="twitter:image"]')?.getAttribute('content') ||
        '';

      const ogUrl =
        document.querySelector('meta[property="og:url"]')?.getAttribute('content') ||
        document.querySelector('link[rel="canonical"]')?.getAttribute('href') ||
        window.location.href;

      // Extract domain from URL
      let domain = 'example.com';
      try {
        domain = new URL(ogUrl).hostname;
      } catch (e) {
        // Fallback
      }

      // Update Facebook preview
      document.getElementById('og-facebook-title')!.textContent = ogTitle;
      document.getElementById('og-facebook-description')!.textContent = ogDescription;
      document.getElementById('og-facebook-url')!.textContent = domain;
      updatePreviewImage('og-facebook-image', ogImage);

      // Update Twitter preview
      document.getElementById('og-twitter-title')!.textContent = ogTitle;
      document.getElementById('og-twitter-description')!.textContent = ogDescription;
      document.getElementById('og-twitter-url')!.textContent = domain;
      updatePreviewImage('og-twitter-image', ogImage);

      // Update LinkedIn preview
      document.getElementById('og-linkedin-title')!.textContent = ogTitle;
      document.getElementById('og-linkedin-url')!.textContent = domain;
      updatePreviewImage('og-linkedin-image', ogImage);

      // Show meta tags
      const metaTags = Array.from(document.querySelectorAll('meta[property^="og:"], meta[name^="twitter:"]'))
        .map((meta) => {
          const property = meta.getAttribute('property') || meta.getAttribute('name');
          const content = meta.getAttribute('content');
          return `<meta ${meta.hasAttribute('property') ? 'property' : 'name'}="${property}" content="${content}" />`;
        })
        .join('\n');

      const metaTagsContent = document.getElementById('og-meta-tags-content');
      if (metaTagsContent) {
        metaTagsContent.textContent = metaTags || 'No OG/Twitter meta tags found';
      }
    }

    function updatePreviewImage(elementId: string, imageUrl: string) {
      const container = document.getElementById(elementId);
      if (!container) return;

      if (imageUrl) {
        container.innerHTML = `<img src="${imageUrl}" alt="OG Image" class="w-full h-full object-cover" />`;
      } else {
        container.innerHTML = `<svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`;
      }
    }
  }
</script>
