---
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';
import type { GoogleMap as Props } from '~/types';

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline = await Astro.slots.render('tagline'),
  placeName,
  address,
  coordinates,
  zoom = 15,
  height = '450px',
  markerTitle,
  showInfoWindow = true,
  mapTypeControl = false,
  streetViewControl = false,
  fullscreenControl = true,
  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// Get API key from environment
const apiKey = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY;

// Unique ID for this map instance
const mapId = id || `google-map-${Math.random().toString(36).substring(7)}`;

// Build data attributes for the script
const mapData = {
  placeName,
  address,
  coordinates: coordinates ? JSON.stringify(coordinates) : undefined,
  zoom,
  markerTitle: markerTitle || placeName || address || 'Our Location',
  showInfoWindow,
  mapTypeControl,
  streetViewControl,
  fullscreenControl,
};
---

<WidgetWrapper id={id} isDark={isDark} containerClass={`max-w-7xl ${classes?.container ?? ''}`} bg={bg}>
  <Headline title={title} subtitle={subtitle} tagline={tagline} classes={classes?.headline} />

  <div class="google-map-container relative" style={`height: ${height}`}>
    {apiKey ? (
      <>
        <!-- Loading Skeleton -->
        <div
          id={`${mapId}-loading`}
          class="absolute inset-0 bg-gray-200 dark:bg-gray-800 animate-pulse rounded-lg flex items-center justify-center"
        >
          <div class="text-center">
            <svg
              class="animate-spin h-12 w-12 text-gray-400 mx-auto mb-4"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <p class="text-gray-500 dark:text-gray-400">Loading map...</p>
          </div>
        </div>

        <!-- Map Container -->
        <div
          id={mapId}
          class="google-map w-full h-full rounded-lg opacity-0 transition-opacity duration-300"
          role="application"
          aria-label={`Map showing location: ${markerTitle || placeName || address || 'location'}`}
          {...mapData}
        >
        </div>

        <!-- Error Container (hidden by default) -->
        <div
          id={`${mapId}-error`}
          class="hidden absolute inset-0 bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-lg flex items-center justify-center p-8"
        >
          <div class="text-center max-w-md">
            <svg
              class="h-12 w-12 text-red-400 mx-auto mb-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
            <h3 class="text-lg font-semibold text-red-800 dark:text-red-300 mb-2">Unable to load map</h3>
            <p class="text-red-600 dark:text-red-400 text-sm mb-4" id={`${mapId}-error-message`}>
              There was an error loading the Google Map. Please try again later.
            </p>
            {(address || placeName) && (
              <a
                href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address || placeName || '')}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors"
              >
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
                Open in Google Maps
              </a>
            )}
          </div>
        </div>
      </>
    ) : (
      <!-- Fallback when no API key -->
      <div class="w-full h-full bg-gray-100 dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 rounded-lg flex items-center justify-center p-8">
        <div class="text-center max-w-md">
          <svg
            class="h-16 w-16 text-gray-400 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
          <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">
            Google Maps API Key Required
          </h3>
          <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">
            To display an interactive map, please add your Google Maps API key to the environment variables.
          </p>
          {(address || placeName) && (
            <a
              href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address || placeName || '')}`}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-colors"
            >
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
              </svg>
              View on Google Maps
            </a>
          )}
        </div>
      </div>
    )}
  </div>
</WidgetWrapper>

{apiKey && (
  <>
    <!-- Load Google Maps JavaScript API -->
    <script
      is:inline
      define:vars={{ apiKey }}
      src={`https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,geocoding&callback=Function.prototype`}
      async
      defer
    ></script>

    <!-- Initialize map -->
    <script>
      import '~/scripts/google-maps';
    </script>
  </>
)}
